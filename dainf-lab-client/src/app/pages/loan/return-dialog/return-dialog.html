<div class="p-fluid p-4">
  <div class="mb-4">
    <h3 class="m-0">Registrar Devolução</h3>
    <p class="text-muted-color">
      Registre a devolução do empréstimo selecionado.
    </p>
  </div>

  <form [formGroup]="form" class="grid grid-cols-12 gap-4">
    <app-input-container
      label="Código"
      class="col-span-12 md:col-span-6 lg:col-span-2"
    >
      <input type="text" pInputText id="loanId" formControlName="loanId" />
    </app-input-container>

    <app-input-container label="Mutuário" class="col-span-12 md:col-span-4">
      <app-search-select
        formControlName="borrower"
        optionLabel="nome"
        [service]="userService"
        placeholder="Selecione um usuário"
      />
    </app-input-container>

    <app-input-container
      label="Data do empréstimo"
      class="col-span-12 md:col-span-4 lg:col-span-2"
    >
      <p-datepicker dateFormat="dd/mm/yy" formControlName="loanDate" />
    </app-input-container>

    <app-input-container
      label="Prazo de devolução"
      class="col-span-12 md:col-span-4 lg:col-span-2"
    >
      <p-datepicker dateFormat="dd/mm/yy" formControlName="deadline" />
    </app-input-container>

    <app-input-container
      class="col-span-12 md:col-span-4 lg:col-span-2"
      label="Data da devolução"
    >
      <p-datepicker
        formControlName="returnDate"
        dateFormat="dd/mm/yy"
        appendTo="body"
      ></p-datepicker>
    </app-input-container>

    <app-input-container label="Observação" class="col-span-12">
      <textarea
        rows="5"
        cols="30"
        pTextarea
        formControlName="observation"
      ></textarea>
    </app-input-container>

    <p-table [value]="savedReturn?.items! || loan.items" class="col-span-12" [rowHover]="true">
      <ng-template pTemplate="header">
        <tr>
          <th>Item</th>
          <th>Emprestado</th>
          <th>Pendente</th>
          <th>Devolvido</th>
          <th>Saída</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-item>
        <tr>
          <td>{{ item.item.name }}</td>
          <td>{{ item.quantity }}</td>
          <td>
            {{ item.quantity - (item.quantityReturned || 0) - (item.quantityIssued || 0) }}
          </td>
          <td [pEditableColumn]="item.quantityReturned" pEditableColumnField="quantityReturned">
            <p-cellEditor>
              <ng-template #input>
                <p-input-number
                  locale="pt-BR"
                  [(ngModel)]="item.quantityReturned"
                  [ngModelOptions]="{standalone: true}"
                  [showButtons]="true"
                  buttonLayout="horizontal"
                  inputId="horizontal"
                  spinnerMode="horizontal"
                  [min]="0"
                  [max]="item.quantity - (item.quantityIssued || 0)"
                ></p-input-number>
              </ng-template>
              <ng-template #output><p-chip label="{{ item.quantityReturned || 0 }}" icon="pi pi-pencil" /></ng-template>
            </p-cellEditor>
          </td>
          <td [pEditableColumn]="item.quantityIssued" pEditableColumnField="quantityIssued">
            <p-cellEditor>
              <ng-template #input>
                <p-input-number
                  locale="pt-BR"
                  [(ngModel)]="item.quantityIssued"
                  [ngModelOptions]="{standalone: true}"
                  [showButtons]="true"
                  buttonLayout="horizontal"
                  inputId="horizontal"
                  spinnerMode="horizontal"
                  [min]="0"
                  [max]="item.quantity - (item.quantityReturned || 0)"
                ></p-input-number>
              </ng-template>
              <ng-template #output><p-chip label="{{ item.quantityIssued || 0 }}" icon="pi pi-pencil" /></ng-template>
            </p-cellEditor>
          </td>
        </tr>
      </ng-template>
    </p-table>

    <div class="col-span-12 flex justify-end gap-3 pt-4">
      <p-button
        label="Cancelar"
        severity="secondary"
        (onClick)="cancel()"
      ></p-button>
      <p-button label="Salvar" severity="success" (onClick)="save()"></p-button>
    </div>
  </form>
</div>
